<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Pinning Julia Tasks · ThreadPinning.jl</title><meta name="title" content="Pinning Julia Tasks · ThreadPinning.jl"/><meta property="og:title" content="Pinning Julia Tasks · ThreadPinning.jl"/><meta property="twitter:title" content="Pinning Julia Tasks · ThreadPinning.jl"/><meta name="description" content="Documentation for ThreadPinning.jl."/><meta property="og:description" content="Documentation for ThreadPinning.jl."/><meta property="twitter:description" content="Documentation for ThreadPinning.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ThreadPinning.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ThreadPinning.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">ThreadPinning</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../ex_pinning_julia_threads/">Pinning Julia Threads</a></li><li class="is-active"><a class="tocitem" href>Pinning Julia Tasks</a><ul class="internal"><li><a class="tocitem" href="#Task-based-multithreading"><span>Task-based multithreading</span></a></li><li><a class="tocitem" href="#Static-scheduling-and-*sticky*-tasks"><span>Static scheduling and <em>sticky</em> tasks</span></a></li></ul></li><li><a class="tocitem" href="../ex_blas/">Pinning BLAS Threads</a></li><li><a class="tocitem" href="../ex_mpi/">MPI + Threads</a></li><li><a class="tocitem" href="../ex_distributed/">Distributed.jl + Threads</a></li><li><a class="tocitem" href="../ex_affinity/">External Affinity Mask</a></li></ul></li><li><span class="tocitem">References</span><ul><li><a class="tocitem" href="../../refs/api_pinning/">API - Pinning</a></li><li><a class="tocitem" href="../../refs/api_querying/">API - Querying</a></li><li><a class="tocitem" href="../../refs/api_other/">API - Other</a></li><li><a class="tocitem" href="../../refs/internals/">Internals</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Pinning Julia Tasks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Pinning Julia Tasks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/carstenbauer/ThreadPinning.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/carstenbauer/ThreadPinning.jl/blob/main/docs/src/examples/ex_pinning_tasks.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Pinning-Julia-Tasks"><a class="docs-heading-anchor" href="#Pinning-Julia-Tasks">Pinning Julia Tasks</a><a id="Pinning-Julia-Tasks-1"></a><a class="docs-heading-anchor-permalink" href="#Pinning-Julia-Tasks" title="Permalink"></a></h1><h2 id="Task-based-multithreading"><a class="docs-heading-anchor" href="#Task-based-multithreading">Task-based multithreading</a><a id="Task-based-multithreading-1"></a><a class="docs-heading-anchor-permalink" href="#Task-based-multithreading" title="Permalink"></a></h2><p>It is important to note that Julia implements <strong>task-based multithreading</strong>: <code>M</code> dynamically created user tasks get scheduled onto <code>N</code> Julia threads. By default, task scheduling is dynamic and is handled by Julia&#39;s built-in scheduler. Similar to how the operating system&#39;s scheduler can freely move Julia threads between CPU threads, Julia&#39;s scheduler can move tasks between Julia threads. Consequently, before pinning, a user cannot reliably predict on which Julia thread a task will run and on which CPU thread a Julia thread will run (see the visualization below).</p><p><img src="../tasks_threads_cores.svg" alt="tasks_threads_cores"/></p><p>The primary purpose of ThreadPinning.jl is to allow you to pin Julia threads to CPU-threads. In this sense, it enables you to supersede the dynamic OS scheduler (right part in the image above). However, the dynamic scheduling of Julia tasks (left part in the image above) remains as is.</p><h2 id="Static-scheduling-and-*sticky*-tasks"><a class="docs-heading-anchor" href="#Static-scheduling-and-*sticky*-tasks">Static scheduling and <em>sticky</em> tasks</a><a id="Static-scheduling-and-*sticky*-tasks-1"></a><a class="docs-heading-anchor-permalink" href="#Static-scheduling-and-*sticky*-tasks" title="Permalink"></a></h2><p>If you want to opt-out of Julia&#39;s dynamic task scheduling and want to &quot;pin&quot; Julia tasks to specific Julia threads, you will often need to use tools from external libraries (such as ThreadPinning.jl), as support for this in base Julia is sparse. The only official API for static scheduling of <em>sticky</em> tasks (i.e. tasks that stay on the Julia thread they&#39;ve been spawned on) is <a href="https://docs.julialang.org/en/v1/base/multi-threading/#Base.Threads.@threads"><code>Threads.@threads :static</code></a>. In code like</p><pre><code class="language-julia hljs">Threads.@threads :static for i in 1:Threads.nthreads()
    do_something_on_thread(i)
end</code></pre><p>it is guaranteed that each Julia thread will run precisely one <em>sticky</em> task that corresponds to one iteration of the loop. Hence, <code>i</code> may be interpreted as a Julia thread index. In fact, it is even guaranteed that the first (default) Julia thread will run the first task (iteration), the second (default) Julia thread will run the second task (iteration), and so on.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Beware, the indices of the <em>default</em> Julia threads (as given by <code>Threads.threadid()</code> if called on them) actually only start at 1 in the absence of <em>interactive</em> threads.</p></div></div><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Under the hood, <code>Threads.@threads</code> always splits up the iteration regime into <code>Threads.nthreads()</code> many tasks, irrespective of the length of the iteration range. In the example above, there is a one-to-one correspondence between iterations and tasks but for general iterations (say, <code>1:N</code> where <code>N &gt; Threads.nthreads()</code>) a task - and consequently a Julia thread - will take care of more than one iteration.</p></div></div><p>The static scheduling option <code>Threads.@threads :static</code> is the only official built-in way to get sticky tasks. In particular, there is no sticky pendant of <code>@spawn</code> for manually creating tasks.</p><p>ThreadPinning.jl aims to fill this gap by providing <a href="../../refs/api_other/#api_stabletasks"><code>ThreadPinning.@spawnat</code></a> and a few other tools. As the name suggests, this macro allows you to spawn a <em>sticky</em> task on a specific Julia thread, e.g. <code>ThreadPinning.@spawnat 3 println(&quot;Hello from thread 3&quot;)</code>.</p><p>Using <code>ThreadPinning.@spawnat</code> we can rewrite the code above as</p><pre><code class="language-julia hljs">@sync for i in 1:Threads.nthreads()
    ThreadPinning.@spawnat i do_something_on_thread(i)
end</code></pre><p>Both the task-iteration mapping and the task-thread assignment are explicitly and immediately visible here.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ex_pinning_julia_threads/">« Pinning Julia Threads</a><a class="docs-footer-nextpage" href="../ex_blas/">Pinning BLAS Threads »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Thursday 8 August 2024 07:25">Thursday 8 August 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
